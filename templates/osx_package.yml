steps:
  - bash: |
      pip3 install dmgbuild biplist
    displayName: 'Install Prerequisites'
  - bash: |
      set -ex
      # Set Qt dir - assume that it is somewhere in /usr/local/Cellar
      QT_INSTALL_DIR=/usr/local/Cellar/qt@5
      QTVER=`ls -d ${QT_INSTALL_DIR}/* | sed "s/.*\(5\.[0-9][0-9]\.[0-9]\)/\1/g"`
      Qt5_ROOT=${QT_INSTALL_DIR}/${QTVER}
      # Get program version
      JV_VERSION=`grep "#define JVVERSION" src/version.h | sed "s/.*\"\(.*\)\"/\1/g"`
    displayName: 'Prepare DMG Dirs'
  - bash: |
      set -ex
       # Get program version
      JV_VERSION=`grep "#define JVVERSION" src/main/version.cpp | sed "s/.*\"\(.*\)\"/\1/g"`
      # Fix icon link
      sed -i -e "s/jv.icns/jv.icns/g" jv-${VERSION}/jv.app/Contents/Info.plist
      # Create DMG
      dmgbuild -s ci/osx/dmgbuild-settings.py -D app=./jv-${VERSION}/jv.app -D icon=./jv-${VERSION}/jv.app/Contents/Resources/jv.icns "jv" jv-${VERSION}.dmg
    displayName: 'Create Disk Images'
  - bash: |
      set -ex
      mkdir packages
      mv JournalViewer*.dmg packages
    displayName: 'Move Artifacts'