steps:
  - bash: |
      set -ex
      wget https://raw.githubusercontent.com/disorderedmaterials/scripts/master/prep-dmg
      chmod u+x ./prep-dmg
      wget https://raw.githubusercontent.com/disorderedmaterials/scripts/master/prep-appimage
      chmod u+x ./prep-appimage
    displayName: 'Prepare AppDirs'
  - bash: |
      set -ex
      echo -e "\nRetrieving linuxdeploy...\n"
      wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage -O linuxdeploy.AppImage
      echo -e "\nRetrieving qt plugin for linuxdeploy...\n"
      wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
      chmod u+x ./linuxdeploy*.AppImage
    displayName: 'Download linuxdeploy Tools'
  - bash: |
      set -ex
      # Set environment vars to locate Qt
      QT_BASE_DIR="/opt/qt${{ parameters.qtver }}"
      export QTDIR=$QT_BASE_DIR
      export PATH=$QT_BASE_DIR/bin:$PATH
      export CMAKE=$QT_BASE_DIR/bin/cmake
      # Extract the version from the source
      export VERSION=`grep "#define JVVERSION" src/main/version.h | sed "s/.*\"\(.*\)\"/\1/g"`
      # Get extra dependencies needed by the App Image
      sudo apt install libxkbcommon-x11-0 libxcb-render0 libxcb-render-util0 libxcb-shape0 libxcb-randr0 libxcb-xfixes0 libxcb-xkb1 libxcb-sync1 libxcb-shm0 libxcb-icccm4 libxcb-keysyms1 libxcb-image0 libxcb-util1 libfontconfig
      # Run on the targets
      ./linuxdeploy.AppImage --appdir JournalViewer-continuous.AppDir --plugin qt --output appimage
    displayName: 'Create AppImages'
  - bash: |
      set -ex
      mkdir packages
      mv JournalViewer-*-x86_64.AppImage packages
    displayName: 'Move Artifacts'